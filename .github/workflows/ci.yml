name: CI # Só para questão de organização, pode ser qualquer nome

# Quando acontecer X coisa, a pipe executa
on: # Dita qual o evento que vai triggar a pipeline (a partir dele que a pipe funciona)
  push:
    branches:
      - main

jobs:
  build:
    name: "Build and Push" # nome do job, pode ser qualquer nome
    
    runs-on: ubuntu-latest # ambiente de execução (máquina virtual) onde o job será executado - Runner do GitHub Actions
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4
      
      - name: "Setup node" # Colocamos a variável node para sabermos qual versão do node está sendo configurada
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "npm"

      # Comandos após a configuração do node
      - run: npm ci
      - run: npm run test

      - name: "Login to Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: "Generate Tag"
        id: generate_tag # ID do step, para que possamos referenciar ele depois (para pegar o output do step)
        # Gera uma tag e coloca no output do job, para ser usada posteriormente (mais facilmente) - O output é uma variável de ambiente que pode ser usada em outros steps
        run: |
          SHA=$(echo $GITHUB_SHA | head -c 7)
          echo "sha=$SHA" >> $GITHUB_OUTPUT


      # 2 de fazer o build da imagem e subir para o Docker Hub
      - name: "Build and Push Docker Image"
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/ci-node:${{ steps.generate_tag.outputs.sha }},${{ secrets.DOCKERHUB_USERNAME }}/ci-node:latest